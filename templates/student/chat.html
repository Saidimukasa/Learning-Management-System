 {% extends 'includes/student_base.html' %} {% load static %} {% block head %}
<meta name="description" content="Learning Management System">
<title>{{ school_name }} | Student :: Chat Room</title>
{% endblock %} {% block content %}

<section class="content">
    <div class="body_scroll">
        <div class="block-header">
            <div class="row">
                <div class="col-lg-7 col-md-6 col-sm-12">
                    <h2>Chat</h2>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html"><i class="zmdi zmdi-home"></i> {{school_name}}</a></li>

                        <li class="breadcrumb-item active">Chat</li>
                    </ul>
                    <button class="btn btn-primary btn-icon mobile_menu" type="button"><i class="zmdi zmdi-sort-amount-desc"></i></button>
                </div>
                <div class="col-lg-5 col-md-6 col-sm-12">
                    <button class="btn btn-primary btn-icon float-right right_icon_toggle_btn" type="button"><i class="zmdi zmdi-arrow-right"></i></button>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row clearfix">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="chat_list">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="zmdi zmdi-search"></i></span>
                                </div>
                                <input type="text" class="form-control" placeholder="Search..." required>
                            </div>
                            <ul class="user_list list-unstyled mb-0 mt-3">
                                {% for grp in groups_participated %}
                                <li>
                                    <a href="javascript:void(0);" onclick="redirect('{{grp.get_absolute_url}}')">
                                        <img src="{{ grp.icon.url }}" alt="avatar" />
                                        <div class="about">
                                            <div class="name">{{grp.name|title}}</div>
                                            <div class="status offline"> <i class="zmdi zmdi-circle"></i> {{grp.description}} </div>
                                        </div>
                                        <span class="float-right" style="font-size: x-small" id="rsb-t{{grp.id}}">05:09 PM</span>
                                    </a>
                                </li>
                                {% endfor %}


                                <li>
                                    <a href="javascript:void(0);" onclick="redirect('{{grp.get_absolute_url}}')">
                                        <img src="{{ grp.icon.url }}" alt="avatar" />
                                        <div class="about">
                                            <div class="name">{{grp.name|title}}</div>
                                            <div class="status offline"> <i class="zmdi zmdi-circle"></i> {{grp.description}} </div>
                                        </div>
                                        <span class="float-right" style="font-size: x-small" id="rsb-t{{grp.id}}">05:09 PM</span>
                                    </a>
                                </li>
                                <li class="active">
                                    <a href="javascript:void(0);">
                                        <img src="{% static 'assets/images/xs/avatar2.jpg' %}" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Aiden Chavez </div>
                                            <div class="status me"> <i class="zmdi zmdi-circle"></i> online </div>
                                        </div>
                                        <span class="float-right" style="font-size: x-small">05:09 PM</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar3.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Mike Thomas</div>
                                            <div class="status online"> <i class="zmdi zmdi-circle"></i> online </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar4.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Erica Hughes</div>
                                            <div class="status online"> <i class="zmdi zmdi-circle"></i> online </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar5.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Ginger Johnston</div>
                                            <div class="status online"> <i class="zmdi zmdi-circle"></i> online </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar6.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Tracy Carpenter</div>
                                            <div class="status offline"> <i class="zmdi zmdi-circle"></i> left 30 mins ago </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar7.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Christian Kelly</div>
                                            <div class="status offline"> <i class="zmdi zmdi-circle"></i> left 10 hours ago </div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar8.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Monica Ward</div>
                                            <div class="status online"><i class="zmdi zmdi-circle"></i> online</div>
                                        </div>
                                    </a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);">
                                        <img src="assets/images/xs/avatar9.jpg" alt="avatar" />
                                        <div class="about">
                                            <div class="name">Dean Henry</div>
                                            <div class="status offline"><i class="zmdi zmdi-circle"></i> offline since Oct 28</div>
                                        </div>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="chat_window body">
                            <div class="chat-header">
                                <div class="user">
                                    <img src="assets/images/xs/avatar2.jpg" alt="avatar" />
                                    <div class="chat-about">
                                        <div class="chat-with">Aiden Chavez</div>
                                        <div class="chat-num-messages">already 8 messages</div>
                                    </div>
                                </div>
                                <div class="setting">
                                    <a href="javascript:void(0);" class="btn btn-sm btn-warning"><i class="zmdi zmdi-camera"></i></a>
                                    <a href="javascript:void(0);" class="btn btn-sm btn-info"><i class="zmdi zmdi-file-text"></i></a>
                                </div>
                                <a href="javascript:void(0);" class="list_btn btn btn-info btn-round float-md-right"><i class="zmdi zmdi-comments"></i></a>
                            </div>
                            <hr>
                            <ul class="chat-history">
                                <li class="clearfix">
                                    <div class="status online message-data text-right">
                                        <span class="time">10:10 AM, Today</span>
                                        <span class="name">Michael</span>
                                        <i class="zmdi zmdi-circle me"></i>
                                    </div>
                                    <div class="message other-message float-right"> Hi Aiden, how are you? How is the project coming along? </div>
                                </li>
                                <li>
                                    <div class="status message-data">
                                        <span class="name">Aiden</span>
                                        <span class="time">10:12 AM, Today</span>
                                    </div>
                                    <div class="message my-message">
                                        <p>Are we meeting today? Project has been already finished and I have results to show you.</p>
                                        <div class="attachment">
                                            <a class="w200" href="javascript:void(0);"><img src="assets/images/image-gallery/2.jpg" alt="" class="img-fluid img-thumbnail"></a>
                                            <a class="w200" href="javascript:void(0);"><img src="assets/images/image-gallery/5.jpg" alt="" class="img-fluid img-thumbnail"></a>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="status message-data">
                                        <span class="name">Aiden</span>
                                        <span class="time">10:31 AM, Today</span>
                                    </div>
                                    <i class="zmdi zmdi-circle" style="color: #04BE5B; font-size: 10px;"></i>
                                    <i class="zmdi zmdi-circle" style="color: #83d0a7; font-size: 10px;"></i>
                                    <i class="zmdi zmdi-circle" style="color:#DAE9DA; font-size: 10px;"></i>
                                </li>
                            </ul>
                            <div class="chat-box">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="zmdi zmdi-mail-send"></i></span>
                                    </div>
                                    <input type="text" class="form-control" placeholder="Enter text here..." required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div id='room-message'>
    {% include 'chat/room_message.html' %}
</div>

<div id='room-preview-img' style='display:none'>
    {% include 'chat/room_preview_image.html' %}
</div>

<script>
    const roomId = '{{chatgroup.id}}'
    var tempDaysWeekdays = [];

    const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${roomId}/`
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        broadcastMessage(data.message, data.username, data.message_type, data.image_caption)
        scrollBottom()
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        console.error(e);
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) { // enter, return
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'message_type': 'text',
                'image_caption': null
            }));
            messageInputDom.value = '';
        }
    };

    document.querySelector('#chat-message-input').onpaste = function(e) {
        let item = e.clipboardData.items[0];
        if (item.type.includes('image')) {
            let blob = item.getAsFile();

            let reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById("snipped-big-img").src = event.target.result;
                document.getElementById('snipped-small-img').src = event.target.result;
            };

            reader.readAsDataURL(blob);
            document.querySelector('#room-preview-img').style.display = 'grid';
            document.querySelector('#room-message').style.display = 'none';
            document.querySelector('#add-caption-input').focus();
        }

    }

    function scrollBottom() {
        let msgbox = document.querySelector(".msg-box")
        msgbox.scrollTop = msgbox.scrollHeight
    }

    function getTime(msg_time) {
        if (msg_time) {
            // define as Date so we can convert to acceptable date time format (with out letter T, ex. 2020-10-10T06:50:14.751 )
            temp = new Date(msg_time);

            // suffix UTC so it will render as local time when it use toLocalString
            var today = new Date(`${temp.toLocaleString()}`);
        } else {
            var today = new Date();
        }

        // format & render to local time
        let time = today.toLocaleString([], {
            hour: '2-digit',
            minute: '2-digit'
        });
        return time

    }

    function broadcastMessage(msg, user, msg_type, img_caption, msg_time) {
        // create a new div element 
        let newDiv = document.createElement("div");
        // and give it some content 
        if (msg_type == 'image') {
            msg = `<img src="${msg}"> <br/> ${img_caption}`;
        }

        if (user == '{{request.user.username}}') {
            var msg1 = `<div class="right-msg-container">
                                <div class="s-message">
                                    <div class="s-msg">${msg}</div>
                                    <div class="s-time">${getTime(msg_time)}</div>
                                </div>
                                <div class="s-tail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" preserveAspectRatio="none" width="8" height="13"><path opacity=".5" d="M5.188 1H0v11.193l6.467-8.625C7.526 2.156 6.958 1 5.188 1z"></path><path fill="#dcf8c6ff" d="M5.188 0H0v11.193l6.467-8.625C7.526 1.156 6.958 0 5.188 0z"></path></svg></div>
                            </div>`
        } else {
            var msg1 = `<div class="left-msg-container">
                                <div class="r-tail"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 13" width="8" height="13"><path opacity=".5" fill="#0000000" d="M1.533 3.568L8 12.193V1H2.812C1.042 1 .474 2.156 1.533 3.568z"></path><path fill="white" d="M1.533 2.568L8 11.193V0H2.812C1.042 0 .474 1.156 1.533 2.568z"></path></svg></div>
                                <div class="r-message" >
                                    <div class="r-user"><a href="#">${user}</a></div>
                                    <div class="r-msg">${msg}</div>
                                    <div class="r-time">${getTime(msg_time)}</div>
                                </div>
                            </div>`
        }

        if (msg_time) {
            showDatesWeekDays(msg_time)
        } else {
            showDatesWeekDays(new Date())
        }

        newDiv.innerHTML = msg1;

        // add the newly created element and its content into the DOM 
        let currentDiv = document.getElementById("new-message-chat");
        let parentDiv = currentDiv.parentNode;
        parentDiv.insertBefore(newDiv, currentDiv);

        setSidebarMessage(msg_type, user, msg);

    }

    document.getElementById('btnClosePreviewImg').onclick = function(e) {
        goRoomMsg();
    }

    document.getElementById('btnSendImg').onclick = function(e) {
        sendImage();
        goRoomMsg();
    }
    document.querySelector('#add-caption-input').onkeyup = function(e) {
        if (e.keyCode === 13) { // enter, return
            sendImage();
            goRoomMsg();
        }
    }

    function redirect(url) {
        window.location = url;
    }

    function goRoomMsg() {
        document.querySelector('#room-message').style.display = 'grid';
        document.querySelector('#room-preview-img').style.display = 'none';
        document.getElementById("snipped-big-img").src = '';
        document.getElementById("snipped-small-img").src = '';
        document.querySelector('#add-caption-input').value = '';
        document.querySelector('#chat-message-input').focus();
    }

    function setSidebarMessage(msg_type, user, msg) {
        // side bar message
        if (msg_type == 'image') {
            document.getElementById('rsb-g{{chatgroup.id}}').innerHTML = 'Photo';
        } else {
            document.getElementById('rsb-g{{chatgroup.id}}').innerHTML = `${user}: ${msg}`;
        }
        document.getElementById('rsb-t{{chatgroup.id}}').innerHTML = getTime();
    }


    function sendImage() {
        chatSocket.send(JSON.stringify({
            'message': document.getElementById("snipped-big-img").src,
            'message_type': 'image',
            'image_caption': document.querySelector('#add-caption-input').value
        }));
    }


    function showDatesWeekDays(date_created) {
        // add the newly created element and its content into the DOM 

        dt = new Date(date_created)

        if (!tempDaysWeekdays.includes(dt.toLocaleDateString())) {
            let newDiv = document.createElement("div");
            let currentDiv = document.getElementById("new-message-chat");
            let parentDiv = currentDiv.parentNode;
            let days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            if (dt.toDateString() == new Date().toDateString()) {
                // display TODAY in message
                date_weekday = 'TODAY';
            } else if (dt > getDateBefore()) {
                // display week day in message
                date_weekday = days[dt.getDay()].toUpperCase()
            } else {
                // display date in message
                date_weekday = dt.toLocaleDateString();
            }

            newDiv.style.display = "grid";
            newDiv.innerHTML = `<div class="date_weekday">${date_weekday}</div>`
            parentDiv.insertBefore(newDiv, currentDiv);

            tempDaysWeekdays.push(dt.toLocaleDateString())
        }

    }

    function getDateBefore(days = 7) {
        // calculate the last 7 days date
        // 7 (days) * 24 (hours) * 60 (minutes) * 60 (seconds) * 1000 (milliseconds ) = 604800000 or 7 days in milliseconds.                
        daysInMs = days * 24 * 60 * 60 * 1000
        return new Date(Date.now() - daysInMs)
    }

    function loadMessage() {
        fetch("{% url 'chat:history' chatgroup.id %}")
            .then(response => response.json())
            .then(data => {
                for (let msg of data) {
                    broadcastMessage(msg.message, msg.username, msg.message_type, msg.image_caption, msg.date_created)
                }
                scrollBottom()
            })
    }
    loadMessage()
</script>

{% endblock %}